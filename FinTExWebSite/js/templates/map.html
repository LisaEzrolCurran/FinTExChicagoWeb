<a id="downloadAnchorElem" style="display:none"></a>
<style>
  #map { height: 580px; width: 70%; margin: 0 auto; margin-top: 150px; }
  .map-container { padding-left: 25px; }

/* @media only screen and (max-width: 1199px) { .map-container { margin-top: 200px;}} */
  @media only screen and (max-width: 992px) {
    .filter-options { margin-top: 100px; }
  }

  #categories { float: left; list-style-type: none; padding-left: 0px; }
  @media (max-width: 991px) {
    #map { width: 100%; margin: 0 auto; }
  }
  #categories li { padding: 3px 0;  }
  label { cursor: pointer; font-size: 12px; }
  .select-all { font-size: 12px; color: #101f5b; }
  svg { vertical-align: middle; }
  .filter-label { color: rgb(16, 31, 91); text-transform: uppercase; color: grey; }
  .filter-header { margin-top: 0px;}
  .company-infowindow h6 { color: grey; font-weight: normal; margin-bottom: 0; }
  .company-infowindow h5, span { color: #101f5b; font-weight: normal; margin-bottom: 0; margin-top: 5px; }
</style>
<div class="map-container row">
  <div class="col-md-2 col-xs-10 col-xs-offset-1 filter-options">
    <div class="row">
      <h4 class="filter-header col-md-8 col-xs-7">Filter Options</h4>
      <a href="#" class="select-all col-md-4 col-xs-3">Check All</a>
      <p class="col-xs-1 filter-options-group">
        <i data-open="true" class="filter-options-toggle fa fa-chevron-down"></i>
        <i style="display: none;" data-open="false" class="filter-options-toggle fa fa-chevron-up"></i>
      </p>
    </div>
    <ul id="categories"></ul>
  </div>
<h4 class="map-header">FinTEx Chicago Business Community </h4>
  <div id="map" class="col-md-8 col-xs-12"></div>
</div>
<script>
var map,
    markers = [],
    infoWindows = [];
function init(){

    var categories = [
        {name: "Banking", color: "3F88C5"},
        {name: "Capital Markets", color: "0F1D5D"},
        {name: "Capital Markets / Regulatory", color: ""},
        {name: "Consulting", color: "43E865" },
        {name: "Data & Analytics", color: "159C39"},
        {name: "Education", color: "39E1AD"},
        {name: "Insurance", color: "8BBEB2"},
        {name: "Investment Management", color: "AF90A9"},
        {name: "Investor", color: "FFE800"},
        {name: "Lending", color: "DC135D"},
        {name: "Media", color: "A3D11F"},
        {name: "Organization", color: "E637BF"},
        {name: "Payments", color: "7B87D4"},
        {name: "Payments / Blockchain", color: ""},
        {name: "Service Provider", color: "FFBF00"},
        {name: "Technology", color: "DE6E4B"}
      ];

    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 41.889805, lng: -87.629878 },
      zoom: 14,
      mapTypeControl: false,
      streetViewControl: false,
      styles: [
        {"featureType":"water","elementType":"geometry","stylers":[{"color":"#e9e9e9"},{"lightness":17}]},
        {"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":20}]},
        {"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"lightness":17}]},
        {"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#ffffff"},{"lightness":29},{"weight":0.2}]},
        {"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":18}]},
        {"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":16}]},
        {"featureType":"poi","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":21}]},
        {"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#dedede"},{"lightness":21}]},
        {"elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"lightness":16}]},
        {"elementType":"labels.text.fill","stylers":[{"saturation":36},{"color":"#333333"},{"lightness":40}]},
        {"elementType":"labels.icon","stylers":[{"visibility":"off"}]},
        {"featureType":"transit","elementType":"geometry","stylers":[{"color":"#f2f2f2"},{"lightness":19}]},
        {"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#fefefe"},{"lightness":20}]},
        {"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#fefefe"},{"lightness":17},{"weight":1.2}]}
      ]
    });

  var $categories = $('#categories');

  $('.filter-options-toggle').on('click', function(e){
    e.preventDefault();

    var $el = $(this),
        toOpen = $el.data().open;

    (toOpen) ? $categories.show() : $categories.hide()
    $('.filter-options-toggle').show();
    $el.hide()
  });

  $.get('/public/companies.json', function(companies){

    function iconPosition(i){
      return new google.maps.Point(iconXPosition(i), iconYPosition(i));
    }

    function iconXPosition(i){
      return (i % 7) * 30
    }

    function iconYPosition(i){
      return Math.floor(i / 7) * 30
    }

    for (var i=0; i < companies.length; i++){
      var company = companies[i],
          categoryIndex;

      $.each(categories, function(j, category){
        if (category.name === company["Category"]){
          categoryIndex = j;
        }
      });

      if (company.lat){
        var marker = new google.maps.Marker({
              position: { lat: company.lat, lng: company.lng },
              map: map,
              title: company["Company Name"],
              category: company["Category"],
              index: i,
              icon: {
                url: '/img/map-marker-sprite.svg',
                size: new google.maps.Size(15, 15),
                origin: iconPosition(categoryIndex)
              }
            });

        markers.push(marker);

        var html = "<div class='company-infowindow'><h5>" + company["Company Name"];
            html += "<span class='category-marker' style='background-position: -" + iconXPosition(categoryIndex) + "px -" + iconYPosition(categoryIndex) + "px;'>";
            html += "</span></h5><h6>" + company["Street Address"] + "</h6><span>" + company["Category"] + "</span></div>";
        var infoWindow = new google.maps.InfoWindow({ content: html });

        infoWindows.push(infoWindow);

        marker.addListener('click', function() {
          for(var j = 0; j < infoWindows.length; j++){
            if (this.index === j){
              infoWindows[j].open(map, this);
            } else {
              infoWindows[j].close();
            }
          }
        });
      }
    }

    var $categories = $('#categories'),
        categoriesHtml = "";
    $.each(categories, function(i, category){
      // style="color: #' + category.color + ';"
      var companyCount = 0;
      $.each(markers, function(i, marker){
        if (marker.category === category.name){ companyCount++; }
      });

      var newHtml = '<li><label class="filter-label" for="category_' + i + '">';
      newHtml += '<img class="unchecked" src="img/unchecked.svg" />';
      newHtml += '<svg width="27px" height="27px" viewBox="0 0 27 27"><g id="Welcome" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="checked" stroke="#7B87D4"><ellipse id="Oval-22" fill-opacity="0.5" fill="#7B87D4" cx="13.5016201" cy="13.5016201" rx="12.5016201" ry="12.5016201"></ellipse><polyline id="Path-2" points="8 13.25 12.3125 17.5 19.5 9"></polyline></g></g></svg>';
      newHtml += '<input checked class="category-filter ng-hide" type="checkbox" value="' + category.name + '" id="category_' + i + '" />&nbsp;&nbsp;';
      newHtml += category.name + '&nbsp;(' + companyCount + ')</label></li>';
      var $newHtml = $(newHtml);
      $newHtml.find('svg #checked').css('stroke', '#' + category.color);
      $newHtml.find('svg ellipse').css('fill', '#' + category.color);
      categoriesHtml += '<li>' + $newHtml.html() + '</li>';
    });

    $categories.html(categoriesHtml);
    $('.unchecked').hide();

    $('.category-filter').on('change', function(){
      filterMap();
    });

    function filterMap(){
      var filters = $('.category-filter');
      $.each(filters, function(i, filter){
        var mapToShow = $(filter).prop("checked") ? map : null;

        var $label = $(filter).parent();
        if (mapToShow){
          $label.find('.unchecked').hide();
          $label.find('svg').show();
        } else {
          $label.find('.unchecked').show();
          $label.find('svg').hide();
        }

        $.each(markers, function(i, marker){
          if (marker.category === $(filter).val()){
            marker.setMap(mapToShow);
          }
        });
      });
    }

    $('.select-all').on('click', function(e){
      e.preventDefault();
      $('.category-filter').prop("checked", true).trigger("change");
    })


  });
  // function sleep (time) {
  //   return new Promise((resolve) => setTimeout(resolve, time));
  // }

  // function geocode(companies, i){
  //   var geocoder = new google.maps.Geocoder(),
  //       company = companies[i];
  //   if (company){
  //     if (!company.lat){
  //       var address = [company["Geocode Address"], company["City"], company["State"], company["Zip"]].join(', ');
  //       if (address.length > 0){
  //         geocoder.geocode({ 'address': address }, function(results, status) {
  //           if (status == google.maps.GeocoderStatus.OK) {
  //             console.log(company["Company Name"])
  //             console.log({ "lat": results[0].geometry.location.lat(), "lng": results[0].geometry.location.lng() });
  //             company.lat = results[0].geometry.location.lat();
  //             company.lng = results[0].geometry.location.lng();
  //           }
  //         });
  //       }
  //     }
  //   }
  //   if (i < companies.length){
  //     sleep(500).then(function(){
  //       geocode(companies, ++i);
  //     });
  //   } else {
  //     var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(companies));
  //     var dlAnchorElem = document.getElementById('downloadAnchorElem');
  //     dlAnchorElem.setAttribute("href", dataStr);
  //     dlAnchorElem.setAttribute("download", "scene.json");
  //     dlAnchorElem.click();
  //   }
  // }

  // $.get('/public/companies.json', function(companies){
  //   geocode(companies, 0);
  // })

  // var newCompanies = [];

  // $.get('/public/companies_new.json', function(new_companies){
  //   $.get('/public/companies.json', function(companies){
  //       $.each(new_companies, function(i, new_company){
  //         var matchFound = false;
  //         $.each(companies, function(j, company){
  //           if (new_company["Company Name"] == company["Company Name"]){
  //             matchFound = true;
  //           }
  //         });
  //         if (!matchFound){
  //           newCompanies.push(new_company);
  //         }
  //       });
  //     geocode(newCompanies, 0);
  //   });
  // });

}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA02W_u8TMd2K6o3yhJi-rF1R0CP2RS2Mg&callback=init" async defer></script>
